@using CyclingPerformance.Web.Models
@using CyclingPerformance.Web.Constants
@using CyclingPerformance.Web.Services

<MudPaper Class="pa-4">
    <MudForm @ref="form" Model="model" Validated="OnValidSubmit">
        <MudSelect Label="Select Mode" @bind-Value="calculationMode" Required="true">
            <MudSelectItem Value="@("PowerToTime")">Input Power, Get Time</MudSelectItem>
            <MudSelectItem Value="@("TimeToPower")">Input Time, Get Power</MudSelectItem>
        </MudSelect>

        @if (calculationMode == "PowerToTime")
        {
            <MudTextField T="double?" Label="Power (P in Watts)" @bind-Value="model.Power" Required="true" />
        }
        else if (calculationMode == "TimeToPower")
        {
            <MudTextField T="double?" Label="Time (minutes)" @bind-Value="model.Time" Required="true" />
        }

        <MudTextField T="double" Label="Mass of Rider (m_rider in kg)" @bind-Value="model.MassOfRider" Required="true" />
        <MudTextField T="double" Label="Mass of Bicycle (m_bike in kg)" @bind-Value="model.MassOfBike" Required="true" />
        <MudTextField T="double" Label="Air Temperature (T in K)" @bind-Value="model.AirTemperatureCelsius" Required="true" />
        <MudTextField T="double" Label="Distance (meters)" @bind-Value="model.Distance" Required="true" />
        <MudTextField T="double" Label="Altitude Gain (meters)" @bind-Value="model.AltitudeGain" Required="true" />

        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="my-3" OnClick="Calculate">Calculate</MudButton>
    </MudForm>

    @if (calculationMode == "PowerToTime" && finishTime != null)
    {
        <MudText Typo="Typo.h6" Color="Color.Primary">Finish Time: @finishTime.Value minutes</MudText>
    }
    else if (calculationMode == "TimeToPower" && requiredPower != null)
    {
        <MudText Typo="Typo.h6" Color="Color.Primary">Required Power: @requiredPower.Value Watts</MudText>
    }
</MudPaper>

@code {
    [Inject] private ICalculationService _calculationService { get; set; } = default!;
    private MudForm form = new();
    private ClimbPowerTimeModel model = new();
    private string calculationMode = "PowerToTime";

    private double? finishTime;
    private double? requiredPower;

    protected override void OnInitialized()
    {
        model = new ClimbPowerTimeModel
            {
                Power = 300,
                Time = 15,
                MassOfRider = 70,
                MassOfBike = 9,
                AirTemperatureCelsius = 25,
                Distance = 3000,           
                AltitudeGain = 300         
            };
    }

    private async void Calculate()
    {
        await form.Validate();

        if (!form.IsValid)
        {
            Console.WriteLine("Form is invalid."); 
            return;
        }

        double airDensity = _calculationService.CalculateAirDensity(model.AirTemperatureKelvin);
        double rollingResistance = _calculationService.CalculateRollingResistance(model.MassOfBike, model.MassOfRider);
        double slopePullForce = _calculationService.CalculateSlopePullForce(model.AltitudeGain, model.Distance, model.MassOfBike, model.MassOfRider);
        double cda = _calculationService.CalculateAeroDragCoefficient(airDensity);

        if (calculationMode == "PowerToTime" && model.Power.HasValue)
        {
            // Use Newton's method to solve for velocity
            double velocity = _calculationService.NewtonMethod(cda, rollingResistance, slopePullForce, model.Power.Value);

            // Calculate time from velocity
            finishTime = _calculationService.CalculateTimeInMinutes(model.Distance, velocity);
        }
        else if (calculationMode == "TimeToPower" && model.Time.HasValue)
        {
            requiredPower = _calculationService.CalculateRequiredPower(
                model.Distance,
                model.Time.Value,
                rollingResistance,
                slopePullForce,
                airDensity
            );
        }
    }

    private void OnValidSubmit()
    {
        Calculate();
    }
}